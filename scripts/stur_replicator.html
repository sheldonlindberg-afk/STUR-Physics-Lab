<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üç± STUR Replicator ‚Äì Stress-to-Failure Visualization</title>
<style>
body{background:#050814;color:#e6edf3;font-family:'Courier New',monospace;margin:0;padding:2rem;}
h1{color:#ffaa00;text-align:center;}
h2{color:#ffcc33;margin-top:2rem;}
.desc{max-width:900px;margin:0 auto 1.5rem auto;line-height:1.5;}
pre{background:#0a0f1f;padding:1rem;border-radius:8px;overflow-x:auto;color:#00ffcc;
    line-height:1.4;box-shadow:0 0 20px #ffaa0055;font-size:0.9rem;}
footer{margin-top:2rem;text-align:center;font-size:0.9em;color:#aaa;}
a{color:#66ccff;}
button{background:#0e1624;color:#5ad0ff;border:1px solid #5ad0ff;
       padding:8px 14px;border-radius:6px;cursor:pointer;
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
       font-size:0.9em;margin:4px;transition:background 0.3s;}
button:hover{background:#152033;}
</style>
</head>
<body>

<h1>üç± STUR Replicator<br>Stress-to-Failure Envelope Visualization</h1>

<p class="desc">
<b>Step 4</b> of the STUR Replicator chain ‚Äî deterministic, JupyterLite-safe simulation and visualization.  
It analyzes your <code>results</code> array from Step 1 and produces JSON summaries and three plots:
failure-mode envelope, energy fraction, and entropy gradient.
</p>

<h2>Python Simulation + Visualization (copy & run in JupyterLite)</h2>

<pre id="codeBlock">#!/usr/bin/env python3
"""
STUR Replicator ‚Äì Step 4 (Standalone Visualizer)
------------------------------------------------
Compatible with JupyterLite (Pyodide). No external files, no try/except.
"""

import numpy as np, matplotlib.pyplot as plt, json

# --- Optional tiny demo dataset so plots render even without Step 1 ---
results = [
    {"class":"inert","mass_kg":1e-6,"t_s":60,"failure_mode":"power","ratio_vs_mc2":1e-12,"dS_worst":0.1},
    {"class":"inert","mass_kg":1e-3,"t_s":60,"failure_mode":"stable","ratio_vs_mc2":1e-9,"dS_worst":0.05},
    {"class":"food","mass_kg":0.01,"t_s":60,"failure_mode":"biology","ratio_vs_mc2":5e-9,"dS_worst":0.2},
    {"class":"organ","mass_kg":1.0,"t_s":60,"failure_mode":"power","ratio_vs_mc2":1e-6,"dS_worst":0.3},
    {"class":"organ","mass_kg":5.0,"t_s":60,"failure_mode":"stable","ratio_vs_mc2":5e-7,"dS_worst":0.15}
]

# --- Helper: collect arrays for plotting at a given time ---
def get_arrays_for_time(results,t_sel):
    out={}
    for r in results:
        if abs(r["t_s"]-t_sel)<1e-9:
            c=r["class"]
            out.setdefault(c,{"mass":[],"ratio":[],"mode":[],"dS_worst":[]})
            out[c]["mass"].append(r["mass_kg"])
            out[c]["ratio"].append(r["ratio_vs_mc2"])
            out[c]["mode"].append(r["failure_mode"])
            out[c]["dS_worst"].append(r["dS_worst"])
    for c in out:
        idx=np.argsort(out[c]["mass"])
        for k in out[c]: out[c][k]=list(np.array(out[c][k])[idx])
    return out

mode_color={"stable":"green","power":"orange","biology":"red"}
mode_marker={"stable":"o","power":"^","biology":"s"}

def scatter_mode(ax,mass,val,mode,cls,y_label,title):
    for m,v,fm in zip(mass,val,mode):
        ax.scatter(m,v,c=mode_color[fm],marker=mode_marker[fm],
                   edgecolors="black",alpha=0.8,label=f"{cls}-{fm}")
    ax.set_xscale("log"); ax.set_xlabel("Mass (kg)")
    ax.set_ylabel(y_label); ax.set_title(title)
    ax.grid(True,which="both",ls=":"); ax.legend(fontsize=7)

mode_numeric={"power":0,"biology":1,"stable":2}

def plot_failure_mode_step(results,t):
    d=get_arrays_for_time(results,t); plt.figure(figsize=(7,4))
    for i,c in enumerate(["inert","food","organ"]):
        if c not in d: continue
        m=np.array(d[c]["mass"]); y=np.array([mode_numeric[x] for x in d[c]["mode"]])
        o=np.argsort(m); plt.step(m[o],y[o]+0.05*i,where="post",label=f"{c}(t={t}s)")
    plt.xscale("log"); plt.yticks([0,1,2],["power","bio","stable"])
    plt.xlabel("Mass (kg)"); plt.ylabel("Mode")
    plt.title(f"Failure-Mode Envelope @ t={t}s")
    plt.legend(fontsize=8); plt.grid(True,which="both",ls=":")
    plt.tight_layout(); plt.show()

def plot_ratio_scatter(results,t):
    d=get_arrays_for_time(results,t); plt.figure(figsize=(7,4))
    for c in ["inert","food","organ"]:
        if c not in d: continue
        for m,r,fm in zip(d[c]["mass"],d[c]["ratio"],d[c]["mode"]):
            plt.scatter(m,r,c=mode_color[fm],marker=mode_marker[fm],
                        edgecolors="black",alpha=0.8,label=f"{c}-{fm}")
    plt.xscale("log"); plt.yscale("log")
    plt.xlabel("Mass (kg)"); plt.ylabel("E_need / (m c¬≤)")
    plt.title(f"Energy Fraction @ t={t}s")
    plt.grid(True,which="both",ls=":")
    h,l=plt.gca().get_legend_handles_labels()
    plt.legend(dict(zip(l,h)).values(),dict(zip(l,h)).keys(),fontsize=7)
    plt.tight_layout(); plt.show()

def plot_dS_vs_mass(results,t):
    d=get_arrays_for_time(results,t); fig,ax=plt.subplots(figsize=(7,4))
    for c in ["inert","food","organ"]:
        if c not in d: continue
        scatter_mode(ax,d[c]["mass"],d[c]["dS_worst"],d[c]["mode"],c,
                     "Worst-case dS_eff","Entropy Gradient vs Mass @ t="+str(t))
    plt.tight_layout(); plt.show()

def summarize_results(results):
    out={"n_total":len(results),"classes":{},
         "times_s":sorted({float(r["t_s"]) for r in results})}
    for c in sorted({r["class"] for r in results}):
        s=[r for r in results if r["class"]==c]; out["classes"][c]={"count":len(s),"failure_modes":{}}
        for fm in ["stable","power","biology"]:
            s2=[r for r in s if r["failure_mode"]==fm]
            if not s2: continue
            m=np.array([r["mass_kg"] for r in s2]); R=np.array([r["ratio_vs_mc2"] for r in s2])
            D=np.array([r["dS_worst"] for r in s2])
            out["classes"][c]["failure_modes"][fm]={"count":len(s2),
              "mass_kg_min":float(m.min()),"mass_kg_max":float(m.max()),
              "ratio_vs_mc2_median":float(np.median(R)),"dS_worst_mean":float(D.mean())}
    return out

# --- Always safe, no try/except ---
print(json.dumps(summarize_results(results),indent=2))
plot_failure_mode_step(results,60)
plot_ratio_scatter(results,60)
plot_dS_vs_mass(results,60)
</pre>

<div style="text-align:center;">
  <button onclick="copyCode()">Copy Script</button>
  <button onclick="openRunner()">Open in JupyterLite</button>
  <a href="../index.html" style="display:inline-block;background:#0e1624;color:#5ad0ff;
     border:1px solid #5ad0ff;padding:8px 14px;border-radius:6px;text-decoration:none;
     font-size:0.9em;margin:4px;">‚Üê STUR Physics Lab</a>
</div>

<footer>¬© 2025 STUR Physics Lab | Unified Resistance Framework | Replicator Step 4</footer>

<script>
function copyCode(){
  navigator.clipboard.writeText(document.getElementById("codeBlock").innerText);
  alert("‚úÖ Code copied to clipboard");
}
function openRunner(){
  window.open("https://jupyter.org/try-jupyter/lab/","_blank");
}
</script>

</body>
</html>
