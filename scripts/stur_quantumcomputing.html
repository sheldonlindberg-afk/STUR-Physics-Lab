<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>STUR QC – Resistance Flow & Continuity</title>
<style>
body {
  margin: 0; padding: 0;
  font-family: "JetBrains Mono", monospace;
  background-color: #000;
  color: #eee;
}
h1 {
  text-align: center;
  color: #00e0ff;
  margin-top: 30px;
  font-weight: 700;
  letter-spacing: 1px;
}
pre {
  background-color: #111;
  color: #0ff;
  border-radius: 8px;
  padding: 15px;
  overflow-x: auto;
  font-size: 13px;
  line-height: 1.4;
  margin: 20px;
}
button {
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-weight: bold;
  cursor: pointer;
  margin: 5px;
}
.copy {
  background-color: #00e0ff;
  color: #000;
}
.jupyter {
  background-color: #f0ad00;
  color: #000;
}
footer {
  text-align: center;
  color: #666;
  font-size: 13px;
  margin: 30px 0;
}
.container {
  max-width: 1000px;
  margin: auto;
  padding: 10px;
}
.center {
  text-align: center;
}
</style>
</head>
<body>
<div class="container">
  <h1>STUR QC – Resistance Flow &amp; Continuity</h1>
  <div class="center">
    <button class="copy" onclick="copyCode()">Copy Script</button>
    <a href="https://jupyterlite.github.io/demo/lab/" target="_blank">
      <button class="jupyter">Open in JupyterLite</button>
    </a>
  </div>
  <pre id="code">
#!/usr/bin/env python3
import numpy as np, math, json
from numpy.linalg import eig
from scipy.linalg import expm
import matplotlib.pyplot as plt

plt.style.use("dark_background")

def S_STUR(r, L0): x=r/L0; return math.tanh(x)*(1.0-math.exp(-x))
I2=np.eye(2,complex)
sx=np.array([[0,1],[1,0]],complex)
sy=np.array([[0,-1j],[1j,0]],complex)
sz=np.array([[1,0],[0,-1]],complex)
s_plus=np.array([[0,1],[0,0]],complex)
s_minus=np.array([[0,0],[1,0]],complex)

def kron_all(ops):
  out=ops[0]
  for op in ops[1:]: out=np.kron(out,op)
  return out
def single_op(pauli,site,N):
  ops=[I2 for _ in range(N)]; ops[site]=pauli; return kron_all(ops)
def two_op(a,i,b,j,N):
  if i==j: raise ValueError("Sites must differ.")
  ops=[I2 for _ in range(N)]; ops[i]=a; ops[j]=b; return kron_all(ops)

def build_R_STUR(N,L0=1,a_lat=1,h0=1,J0=1,Omega=0.5):
  dim=2**N; R=np.zeros((dim,dim),complex); pos=np.array([i*a_lat for i in range(N)],float)
  for i in range(N):
    S_i=S_STUR(pos[i],L0); R+=h0*S_i*single_op(sz,i,N)
  for i in range(N):
    for j in range(i+1,N):
      S_ij=S_STUR(abs(pos[i]-pos[j]),L0); J_ij=J0*S_ij
      R+=J_ij*(two_op(sx,i,sx,j,N)+two_op(sy,i,sy,j,N))
  for i in range(N):
    S_i=S_STUR(pos[i],L0); R+=Omega*S_i*single_op(sx,i,N)
  return R,pos

def evolve_STUR(R,psi0,t_final,n_steps,hbar=1):
  dt=t_final/n_steps; U=expm(-1j*R*dt/hbar)
  psi=psi0.copy(); traj=[psi.copy()]
  for _ in range(n_steps):
    psi=U@psi; psi/=np.linalg.norm(psi); traj.append(psi.copy())
  return np.array(traj),dt

def entanglement_entropy(psi,N,NA):
  NB=N-NA; psi=psi.reshape(2**NA,2**NB); rho=psi@psi.conj().T
  vals,_=eig(rho); vals=np.clip(np.real(vals),0,1)
  vals=vals[vals>1e-12]; return float(-np.sum(vals*np.log2(vals))) if len(vals)>0 else 0

def resistance_flux(psi,R): return float(np.real(np.vdot(psi,R@psi)))

def local_density_ops(N): return [0.5*(single_op(I2,i,N)-single_op(sz,i,N)) for i in range(N)]
def local_densities(traj,ops): return np.array([[np.real(np.vdot(p,o@p)) for o in ops] for p in traj])

def bond_currents(traj,N,pos,L0,J0):
  plus={i:single_op(s_plus,i,N) for i in range(N)}; minus={i:single_op(s_minus,i,N) for i in range(N)}
  out=[]
  for psi in traj:
    M=np.zeros((N,N))
    for i in range(N):
      for j in range(N):
        if i==j: continue
        S=S_STUR(abs(pos[i]-pos[j]),L0); J=J0*S
        expv=np.vdot(psi,plus[i]@minus[j]@psi); M[i,j]=4*J*np.imag(expv)
    out.append(M)
  return np.array(out)

def continuity_max_residual(dens,curr,dt):
  T,N=dens.shape; m=0
  for t in range(1,T-1):
    d=(dens[t+1]-dens[t-1])/(2*dt)
    for i in range(N):
      r=d[i]+np.sum(curr[t][i,:]); m=max(m,abs(r))
  return m

def make_plots_and_json(dens,curr,dt,J_index=(0,1),S=None,F=None,path="stur_qc_summary.json"):
  T,N=dens.shape; t=np.linspace(0,dt*(T-1),T)
  fig,ax=plt.subplots(); im=ax.imshow(dens.T,aspect='auto',origin='lower',extent=[t[0],t[-1],0,N-1])
  ax.set_xlabel("time"); ax.set_ylabel("site"); ax.set_title("ρᵢ(t)"); fig.colorbar(im,ax=ax)
  fig.tight_layout(); fig.savefig("stur_qc_densities.png",dpi=200)
  i,j=J_index; Jt=curr[:,i,j]
  fig,ax=plt.subplots(); ax.plot(t,Jt); ax.set_xlabel("time"); ax.set_ylabel("J"); ax.set_title("Bond Current")
  fig.tight_layout(); fig.savefig("stur_qc_current.png",dpi=200)
  if S is not None or F is not None:
    fig,ax=plt.subplots()
    if S is not None: ax.plot(t[:len(S)],S,label="S_A(bits)")
    if F is not None: ax.plot(t[:len(F)],F,'--',label="Φ_R")
    ax.legend(); ax.set_xlabel("time"); ax.set_title("Global Invariants")
    fig.tight_layout(); fig.savefig("stur_qc_globals.png",dpi=200)
  json.dump({"N":int(N),"T":int(T),"dt":float(dt),"J_index":[i,j]},open(path,"w"),indent=2)

if __name__=="__main__":
  N,NA,L0,a,h0,J0,Om,tF,nS=6,3,1,1,1,0.8,0.6,5,200
  R,pos=build_R_STUR(N,L0,a,h0,J0,Om)
  psi0=np.zeros(2**N,complex); psi0[0]=1
  traj,dt=evolve_STUR(R,psi0,tF,nS)
  S=[entanglement_entropy(p,N,NA) for p in traj]; F=[resistance_flux(p,R) for p in traj]
  print("Max S_A=",max(S)); print("Flux drift=",max(F)-min(F))
  R2,pos=build_R_STUR(N,L0,a,0,J0,0)
  psi=np.zeros(2**N,complex); psi[1]=1
  traj2,dt2=evolve_STUR(R2,psi,1,400)
  dens=local_densities(traj2,local_density_ops(N))
  curr=bond_currents(traj2,N,pos,L0,J0)
  print("Continuity max",continuity_max_residual(dens,curr,dt2))
  make_plots_and_json(dens,curr,dt2,S=S,F=F)
  print("Done.")
  </pre>
  <div class="center">
    <button class="copy" onclick="copyCode()">Copy Script</button>
    <a href="https://jupyterlite.github.io/demo/lab/" target="_blank">
      <button class="jupyter">Open in JupyterLite</button>
    </a>
  </div>
  <footer>STUR Physics Lab – Resistance Flow & Continuity • © 2025 Sheldon Lon Lindberg</footer>
</div>

<script>
function copyCode(){
  const text=document.getElementById("code").innerText;
  navigator.clipboard.writeText(text).then(()=>alert("STUR QC script copied!"));
}
</script>
</body>
</html>
