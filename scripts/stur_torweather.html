#!/usr/bin/env python3
# ===============================================================
# STUR Weather – Hybrid Atmospheric Field Simulation
# Static plots + JSON summary (no animation)
# ===============================================================
import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D  # required for 3D projection
import json

# ----------------- CONSTANTS -----------------------------------
k_e  = 8.9875e9      # Coulomb constant (N m^2 / C^2)
G    = 6.6743e-11    # Gravitational constant (N m^2 / kg^2)
sigma_strong = 1e-5  # strong analog parameter
lam  = 1e-15         # strong range (m)
lB   = 1e2           # spin decay length (m)

q1, q2 = 1e-6, 1e-6  # charges (C)
m1, m2 = 1e3, 1e3    # effective masses (kg)
S_vec   = np.array([0.0, 0.0, 1.0])
B_vec   = np.array([0.0, 0.0, 1.0])

rho_air = 1.2        # kg/m^3
g       = 9.81       # m/s^2
nu      = 1e-2       # effective viscosity coefficient

L0_mod  = 1e5        # STUR radial modulation scale
gamma0  = 1e-3       # spin-torque coefficient
dt      = 0.5        # time step (s)
n_steps = 80         # number of evolution steps
np.random.seed(0)    # reproducible noise

# ----------------- STUR MODULATOR & FORCE ----------------------
def S_r(r, L0):
    """STUR radial modulator S(r,L0)."""
    return np.tanh(r/L0) * (1.0 - np.exp(-r/L0))

def F_sheldon(r_vec, v_vec, L0=L0_mod, gamma0=gamma0, alpha_s=1e-9):
    """
    Unified Coulomb–gravity–strong + spin-torque force on a parcel.
    r_vec: position (3,)
    v_vec: velocity (3,)  [not used explicitly here but kept for extensibility]
    """
    r_norm = max(float(np.linalg.norm(r_vec)), 1e-12)
    r_hat  = r_vec / r_norm
    coulomb = k_e * q1 * q2 / r_norm**2
    grav    = -G * m1 * m2 / r_norm**2
    strong  = alpha_s * ((1.0 - np.exp(-r_norm/lam))/r_norm**2 + sigma_strong * r_norm)
    F_rad = S_r(r_norm, L0) * (coulomb + grav + strong) * r_hat
    F_spin = gamma0 * np.exp(-r_norm/lB) * np.cross(S_vec, B_vec)
    return F_rad + F_spin

# ----------------- ATMOSPHERIC GRID ----------------------------
nx, ny, nz = 8, 8, 8
X, Y, Z = np.meshgrid(
    np.linspace(-1e3, 1e3, nx),
    np.linspace(-1e3, 1e3, ny),
    np.linspace(0.0, 500.0, nz)
)

pos = np.stack([X.flatten(), Y.flatten(), Z.flatten()], axis=-1).astype(float)
vel = np.zeros_like(pos)
T   = np.ones(pos.shape[0]) * 290.0      # K
P   = np.ones(pos.shape[0]) * 101325.0   # Pa

# maximum allowed speed to avoid runaway (m/s)
V_MAX = 80.0

# ----------------- TIME EVOLUTION ------------------------------
for step in range(n_steps):
    # background horizontal shear in x-direction, proportional to y
    vel[:, 0] += 0.0001 * (pos[:, 1] / 1e3)

    for i in range(pos.shape[0]):
        # fluid contribution: vertical pressure deviation + small random turbulence
        F_fluid = -1.0 / rho_air * np.array([0.0, 0.0, (P[i] - 101325.0) / 50.0])
        F_fluid += nu * np.random.randn(3) * 0.01

        # STUR hybrid force
        F_total = F_fluid + F_sheldon(pos[i], vel[i])

        # update velocity
        vel[i] += F_total * dt
        vnorm = float(np.linalg.norm(vel[i]))
        if vnorm > V_MAX:
            vel[i] *= V_MAX / vnorm

        # update position
        pos[i] += vel[i] * dt

        # temperature and pressure evolution (simple vertical coupling)
        T[i] += -(g / 1000.0) * vel[i, 2] * dt
        P[i] -= 0.05 * vel[i, 2] * dt

# ----------------- EVENT DETECTION -----------------------------
# microbursts: strong downward vertical velocity
microbursts = vel[:, 2] < -10.0

# funnels: strong vertical angular momentum about z-axis
r2d = pos[:, :2]
v2d = vel[:, :2]
Lz  = v2d[:, 0] * r2d[:, 1] - v2d[:, 1] * r2d[:, 0]
funnels = np.abs(Lz) > 0.05

# heat domes: elevated temperature
heat_domes = T > 300.0

# ----------------- PLOTTING -----------------------------------
fig = plt.figure(figsize=(15, 4))

# 1) Microbursts
ax1 = fig.add_subplot(131, projection="3d")
ax1.scatter(pos[:, 0], pos[:, 1], pos[:, 2],
            c="#444444", s=5, alpha=0.3)
ax1.scatter(pos[microbursts, 0], pos[microbursts, 1], pos[microbursts, 2],
            c="cyan", s=25, label="Microbursts")
ax1.set_title("Microbursts (v_z < -10 m/s)")
ax1.set_xlim(-1e3, 1e3); ax1.set_ylim(-1e3, 1e3); ax1.set_zlim(0, 500)
ax1.set_xlabel("X (m)"); ax1.set_ylabel("Y (m)"); ax1.set_zlabel("Z (m)")
ax1.legend(loc="best")

# 2) Funnels
ax2 = fig.add_subplot(132, projection="3d")
ax2.scatter(pos[:, 0], pos[:, 1], pos[:, 2],
            c="#444444", s=5, alpha=0.3)
ax2.scatter(pos[funnels, 0], pos[funnels, 1], pos[funnels, 2],
            c="magenta", s=25, label="Funnels")
ax2.set_title("Funnels (|L_z| > 0.05)")
ax2.set_xlim(-1e3, 1e3); ax2.set_ylim(-1e3, 1e3); ax2.set_zlim(0, 500)
ax2.set_xlabel("X (m)"); ax2.set_ylabel("Y (m)"); ax2.set_zlabel("Z (m)")
ax2.legend(loc="best")

# 3) Heat domes
ax3 = fig.add_subplot(133, projection="3d")
ax3.scatter(pos[:, 0], pos[:, 1], pos[:, 2],
            c="#444444", s=5, alpha=0.3)
ax3.scatter(pos[heat_domes, 0], pos[heat_domes, 1], pos[heat_domes, 2],
            c="red", s=25, label="Heat Domes")
ax3.set_title("Heat Domes (T > 300 K)")
ax3.set_xlim(-1e3, 1e3); ax3.set_ylim(-1e3, 1e3); ax3.set_zlim(0, 500)
ax3.set_xlabel("X (m)"); ax3.set_ylabel("Y (m)"); ax3.set_zlabel("Z (m)")
ax3.legend(loc="best")

plt.tight_layout()
plt.show()

# ----------------- JSON SUMMARY -------------------------------
summary = {
    "model": "STUR Weather Hybrid Atmosphere",
    "grid": {
        "nx": int(nx), "ny": int(ny), "nz": int(nz),
        "n_parcels": int(pos.shape[0])
    },
    "time": {
        "dt_s": float(dt),
        "n_steps": int(n_steps),
        "total_time_s": float(dt * n_steps)
    },
    "events": {
        "microbursts_count": int(np.sum(microbursts)),
        "funnels_count": int(np.sum(funnels)),
        "heat_domes_count": int(np.sum(heat_domes))
    },
    "fields": {
        "T_min_K": float(np.min(T)),
        "T_max_K": float(np.max(T)),
        "vz_min_m_per_s": float(np.min(vel[:, 2])),
        "vz_max_m_per_s": float(np.max(vel[:, 2])),
        "Lz_min": float(np.min(Lz)),
        "Lz_max": float(np.max(Lz))
    }
}

print("JSON summary:")
print(json.dumps(summary, indent=2))
print("STUR Weather hybrid simulation complete.")
